<div class="canvas-container" 
     #canvas
     (click)="onCanvasClick($event)"
     (drop)="onCanvasDrop($event)"
     (dragover)="onCanvasDragOver($event)"
     [class.connecting]="isConnecting">
  
  <!-- ç½‘æ ¼èƒŒæ™¯ -->
  <div class="grid-background"></div>
  
  <!-- è¿æ¥çº¿ -->
  <svg class="workflow-canvas" width="100%" height="100%" #svg>
    <!-- ä¸´æ—¶è¿çº¿ -->
    <g *ngIf="isConnecting && tempConnection">
      <line 
        [attr.x1]="getNodeCoordinates(connectionSource).x"
        [attr.y1]="getNodeCoordinates(connectionSource).y"
        [attr.x2]="tempConnection.x"
        [attr.y2]="tempConnection.y"
        class="temp-edge"></line>
    </g>
    
    <!-- æ­£å¼è¿çº¿ -->
    <g *ngFor="let edge of edges">
      <line 
        [attr.x1]="getNodeCoordinates(edge.source).x"
        [attr.y1]="getNodeCoordinates(edge.source).y"
        [attr.x2]="getNodeCoordinates(edge.target).x"
        [attr.y2]="getNodeCoordinates(edge.target).y"
        [ngClass]="getEdgeClass(edge)"></line>
      
      <!-- è¿çº¿æ ‡ç­¾ -->
      <text 
        [attr.x]="getEdgeMidpoint(edge).x"
        [attr.y]="getEdgeMidpoint(edge).y - 5"
        class="edge-label"
        *ngIf="edge.label">
        {{edge.label}}
      </text>
      
      <!-- ç®­å¤´ -->
      <polygon 
        [attr.points]="getArrowPoints(edge)"
        class="edge-arrow"></polygon>
    </g>
  </svg>
  
  <!-- èŠ‚ç‚¹ -->
  <div class="nodes-container">
    <div *ngFor="let node of nodes"
         class="workflow-node"
         [ngClass]="getNodeClass(node)"
         [style.left.px]="node.position.x - 30"
         [style.top.px]="node.position.y - 15"
         (mousedown)="onNodeMouseDown(node, $event)"
         (click)="onNodeClick(node, $event)">
      
      <!-- èŠ‚ç‚¹å›¾æ ‡å’Œæ ‡ç­¾ -->
      <div class="node-content">
        <mat-icon class="node-icon" fontIcon="{{getNodeIcon(node.type)}}">{{getNodeIcon(node.type)}}</mat-icon>
        <span class="node-label">{{node.label}}</span>
      </div>
      
      <      <!-- èŠ‚ç‚¹æ“ä½œæŒ‰é’® -->
      <div class="node-actions" *ngIf="selectedNode?.id === node.id">
        <button mat-mini-fab 
                class="connect-btn"
                (click)="startConnection(node.id); $event.stopPropagation()"
                matTooltip="å¼€å§‹è¿çº¿"
                color="primary"
                style="background: #1976d2; color: white;">
          <mat-icon fontIcon="link">ğŸ”—</mat-icon>
        </button>
        <button mat-mini-fab 
                class="delete-btn"
                (click)="deleteNode(node.id); $event.stopPropagation()"
                matTooltip="åˆ é™¤èŠ‚ç‚¹"
                color="warn"
                style="background: #d32f2f; color: white;">
          <mat-icon fontIcon="delete">ğŸ—‘ï¸</mat-icon>
        </button>
      </div>
      
      <!-- è¿æ¥ç›®æ ‡åŒºåŸŸï¼ˆå½“è¿çº¿æ¨¡å¼æ—¶æ˜¾ç¤ºï¼‰ -->
      <div class="connection-target" 
           *ngIf="isConnecting && connectionSource !== node.id"
           (click)="finishConnection(node.id); $event.stopPropagation()">
      </div>
    </div>
  </div>
  
  <!-- æç¤ºä¿¡æ¯ -->
  <div class="canvas-hints" *ngIf="nodes.length === 0">
    <div class="hint-text">
      <mat-icon>info</mat-icon>
      <p>ä»å·¦ä¾§æ‹–æ‹½èŠ‚ç‚¹åˆ°ç”»å¸ƒå¼€å§‹åˆ›å»ºæµç¨‹</p>
    </div>
  </div>
  
  <!-- è¿çº¿æç¤º -->
  <div class="connection-hint" *ngIf="isConnecting">
    <mat-icon>gesture</mat-icon>
    <span>ç‚¹å‡»ç›®æ ‡èŠ‚ç‚¹å®Œæˆè¿çº¿</span>
  </div>
</div>